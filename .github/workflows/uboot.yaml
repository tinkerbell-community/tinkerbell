name: U-Boot for Raspberry Pi Build

on:
  workflow_dispatch:
    inputs:
      uboot_version:
        description: "U-Boot version tag to build"
        required: false
        default: "v2025.07"
        type: string
  schedule:
    # Run weekly on Sundays at 2 AM UTC to check for updates
    - cron: "0 2 * * 0"

env:
  UBOOT_VERSION: ${{ inputs.uboot_version || 'v2025.07' }}

jobs:
  build-uboot:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            python3 \
            python3-setuptools \
            bison \
            flex \
            bc \
            libssl-dev \
            libgnutls28-dev \
            libgcrypt20-dev \
            zlib1g-dev \
            libcurl4-openssl-dev \
            gcc-aarch64-linux-gnu \
            device-tree-compiler

      - name: Create build directory
        run: mkdir -p /tmp/uboot-build

      - name: Clone U-Boot source
        run: |
          cd /tmp/uboot-build
          git clone --depth 1 --branch ${{ env.UBOOT_VERSION }} https://github.com/u-boot/u-boot.git
          echo "Cloned U-Boot version: ${{ env.UBOOT_VERSION }}"

      - name: Configure U-Boot for Raspberry Pi 4 ARM64
        run: |
          cd /tmp/uboot-build/u-boot
          make CROSS_COMPILE=aarch64-linux-gnu- rpi_arm64_defconfig

      - name: Add custom boot configuration
        run: |
          cd /tmp/uboot-build/u-boot
          echo 'CONFIG_BOOTCOMMAND="dhcp; pxe get; pxe boot"' >> .config
          echo 'CONFIG_USE_BOOTCOMMAND=y' >> .config
          echo 'CONFIG_ARMV8_PSCI=y' >> .config
          echo 'CONFIG_ARMV8_PSCI_NR_CPUS=4' >> .config
          echo 'CONFIG_ARMV8_PSCI_CPUS_PER_CLUSTER=4' >> .config
          echo 'CONFIG_ARMV8_SPIN_TABLE=n' >> .config
          echo 'CONFIG_ARM64=y' >> .config
          echo 'CONFIG_POSITION_INDEPENDENT=y' >> .config
          echo 'CONFIG_ARMV8_SEC_FIRMWARE_SUPPORT=n' >> .config
          echo 'CONFIG_OF_LIBFDT=y' >> .config
          echo 'CONFIG_OF_CONTROL=y' >> .config

      - name: Build U-Boot
        run: |
          cd /tmp/uboot-build/u-boot
          make CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
          ls -la u-boot.bin

      - name: Check if u-boot.bin changed
        id: check_changes
        run: |
          cd /tmp/uboot-build/u-boot

          # Create output directory
          mkdir -p ${{ github.workspace }}/smee/internal/firmware

          # Check if the new binary is different from the existing one
          if [ -f "${{ github.workspace }}/smee/internal/firmware/u-boot.bin" ]; then
            if cmp -s u-boot.bin "${{ github.workspace }}/smee/internal/firmware/u-boot.bin"; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "U-Boot binary is unchanged"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "U-Boot binary has changed"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "No existing U-Boot binary found, will create new one"
          fi

          # Copy the new binary
          cp u-boot.bin "${{ github.workspace }}/smee/internal/firmware/"

          # Get file size for reporting
          size=$(stat -c%s "${{ github.workspace }}/smee/internal/firmware/u-boot.bin")
          echo "size=$size" >> $GITHUB_OUTPUT

      - name: Build PSCI device tree overlay
        run: |
          cd /tmp/uboot-build/u-boot

          cat <<EOF > psci.dts
          /dts-v1/;
          /plugin/;

          / {
              compatible = "brcm,bcm2711", "brcm,bcm2837", "brcm,bcm2835";
              
              fragment@0 {
                  target-path = "/";
                  __overlay__ {
                      psci {
                          compatible = "arm,psci-1.0", "arm,psci-0.2", "arm,psci";
                          method = "smc";
                          
                          /* PSCI function IDs */
                          cpu_suspend = <0xc4000001>;
                          cpu_off = <0x84000002>;
                          cpu_on = <0xc4000003>;
                          affinity_info = <0xc4000004>;
                          migrate = <0xc4000005>;
                          migrate_info_type = <0x84000006>;
                          system_off = <0x84000008>;
                          system_reset = <0x84000009>;
                      };
                  };
              };
              
              fragment@1 {
                  target-path = "/cpus";
                  __overlay__ {
                      #address-cells = <1>;
                      #size-cells = <0>;
                      
                      cpu@0 {
                          enable-method = "psci";
                      };
                      
                      cpu@1 {
                          enable-method = "psci";
                      };
                      
                      cpu@2 {
                          enable-method = "psci";
                      };
                      
                      cpu@3 {
                          enable-method = "psci";
                      };
                  };
              };
          };
          EOF
          dtc -@ -I dts -O dtb -o psci.dtbo psci.dts

      - name: Check if psci.dtbo changed
        id: check_psci_changes
        run: |
          cd /tmp/uboot-build/u-boot
          
          # Create overlays directory
          mkdir -p "${{ github.workspace }}/smee/internal/firmware/overlays"
          
          if [ -f "${{ github.workspace }}/smee/internal/firmware/overlays/psci.dtbo" ]; then
            if cmp -s psci.dtbo "${{ github.workspace }}/smee/internal/firmware/overlays/psci.dtbo"; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "PSCI overlay is unchanged"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "PSCI overlay has changed"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "No existing PSCI overlay found, will create new one"
          fi
          
          # Copy the new overlay
          cp psci.dtbo "${{ github.workspace }}/smee/internal/firmware/overlays/"

          # Get file size for reporting
          size=$(stat -c%s "${{ github.workspace }}/smee/internal/firmware/overlays/psci.dtbo")
          echo "size=$size" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true' || steps.check_psci_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update U-Boot binary to ${{ env.UBOOT_VERSION }}

            - Built U-Boot ${{ env.UBOOT_VERSION }} for Raspberry Pi 4 ARM64
            - Binary size: ${{ steps.check_changes.outputs.size }} bytes
            - PSCI overlay size: ${{ steps.check_psci_changes.outputs.size }} bytes
            - Configured for PXE boot: "dhcp; pxe get; pxe boot"
            - Enabled ARMV8_PSCI for multi-core CPU power management
            - Built natively on ubuntu-24.04-arm runner
          title: "chore: Update U-Boot binary to ${{ env.UBOOT_VERSION }}"
          body: |
            ## U-Boot Build Update

            This PR updates the U-Boot binary to version `${{ env.UBOOT_VERSION }}`.

            ### Changes
            - ‚úÖ Built U-Boot ${{ env.UBOOT_VERSION }} for Raspberry Pi 4 ARM64
            - ‚úÖ U-Boot binary size: ${{ steps.check_changes.outputs.size }} bytes
            - ‚úÖ PSCI overlay size: ${{ steps.check_psci_changes.outputs.size }} bytes
            - ‚úÖ Configured with custom bootcommand: `dhcp; pxe get; pxe boot`
            - ‚úÖ Built natively on `ubuntu-24.04-arm` runner (no cross-compilation)

            ### Build Configuration
            - **Target**: `rpi_arm64_defconfig` (Raspberry Pi 4 ARM64)
            - **Compiler**: `aarch64-linux-gnu-gcc`
            - **Boot Method**: PXE/DHCP boot for diskless operation
            - **PSCI Support**: Enabled for multi-core CPU power management
              - `CONFIG_ARMV8_PSCI=y` - ARM v8 PSCI support
              - `CONFIG_ARMV8_PSCI_NR_CPUS=4` - Support for 4 CPU cores
              - `CONFIG_ARMV8_PSCI_CPUS_PER_CLUSTER=4` - 4 cores per cluster
              - Device tree overlay: `psci.dtbo` for runtime PSCI enablement

            ### Verification
            The build process replicated the same steps as the Docker-based build in `cmd/uboot/` but executed natively on ARM64 hardware for optimal compatibility.

            ---

            *This PR was automatically created by the U-Boot build workflow.*
          branch: update-uboot-${{ env.UBOOT_VERSION }}-${{ github.run_number }}
          delete-branch: true
          draft: false
          labels: |
            firmware
            uboot
            automated-pr

      - name: Report build status
        run: |
          uboot_changed="${{ steps.check_changes.outputs.changed }}"
          psci_changed="${{ steps.check_psci_changes.outputs.changed }}"
          
          if [ "$uboot_changed" == "true" ] || [ "$psci_changed" == "true" ]; then
            echo "‚úÖ Build completed successfully"
            echo "üìù Pull request created with updated files:"
            
            if [ "$uboot_changed" == "true" ]; then
              echo "   - U-Boot binary (${{ steps.check_changes.outputs.size }} bytes)"
            fi
            
            if [ "$psci_changed" == "true" ]; then
              echo "   - PSCI overlay (${{ steps.check_psci_changes.outputs.size }} bytes)"
            fi
          else
            echo "‚ÑπÔ∏è Both U-Boot binary and PSCI overlay are up-to-date, no changes needed"
          fi
