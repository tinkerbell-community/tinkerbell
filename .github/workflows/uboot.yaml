name: U-Boot for Raspberry Pi Build

on:
  workflow_dispatch:
    inputs:
      uboot_version:
        description: "U-Boot version tag to build"
        required: false
        default: "v2025.10"
        type: string
  schedule:
    # Run weekly on Sundays at 2 AM UTC to check for updates
    - cron: "0 2 * * 0"

env:
  UBOOT_VERSION: ${{ inputs.uboot_version || 'v2025.10' }}
  UBOOT_DIR: ${{ github.workspace }}/u-boot

jobs:
  build-uboot:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: main

      - name: Checkout u-boot
        uses: actions/checkout@v4
        with:
          repository: u-boot/u-boot
          fetch-depth: 1
          path: u-boot
          ref: ${{ env.UBOOT_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            python3 \
            python3-setuptools \
            bison \
            flex \
            bc \
            libssl-dev \
            libgnutls28-dev \
            libgcrypt20-dev \
            zlib1g-dev \
            libcurl4-openssl-dev \
            gcc-aarch64-linux-gnu \
            device-tree-compiler

      - name: Configure U-Boot for Raspberry Pi 4 ARM64
        working-directory: ${{ env.UBOOT_DIR }}
        run: |
          for f in ${{ github.workspace }}/main/smee/internal/firmware/patches/*.patch; do
            echo "Applying patch: $f"
            patch -p1 < "$f"
          done

          make CROSS_COMPILE=aarch64-linux-gnu- rpi_arm64_defconfig

      - name: Add custom boot configuration
        working-directory: ${{ env.UBOOT_DIR }}
        run: |
          echo 'CONFIG_BOOTCOMMAND="setenv bootfile snp-arm64.efi; setenv autoload no; echo Attempting network boot via DHCP...; if dhcp; then echo DHCP successful, downloading boot file...; if tftp ${loadaddr} ${bootfile}; then echo Download successful, attempting EFI boot from network...; bootefi ${loadaddr}; fi; fi; echo Network boot failed or unavailable; echo Attempting EFI boot from disk...; if usb start; then if load usb 0:1 ${kernel_addr_r} /EFI/BOOT/bootaa64.efi; then bootefi ${kernel_addr_r}; fi; if load usb 0:1 ${kernel_addr_r} /EFI/BOOT/bootx64.efi; then bootefi ${kernel_addr_r}; fi; fi; echo All boot attempts failed"' >> .config
          echo 'CONFIG_USE_BOOTCOMMAND=y' >> .config

      - name: Build U-Boot
        working-directory: ${{ env.UBOOT_DIR }}
        run: |
          make CROSS_COMPILE=aarch64-linux-gnu- -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto"
          ls -la u-boot.bin

      - name: Check if u-boot.bin changed
        id: check_changes
        working-directory: ${{ env.UBOOT_DIR }}
        run: |
          # Create output directory
          mkdir -p ${{ github.workspace }}/main/smee/internal/firmware

          # Check if the new binary is different from the existing one
          if [ -f "${{ github.workspace }}/main/smee/internal/firmware/u-boot.bin" ]; then
            if cmp -s u-boot.bin "${{ github.workspace }}/main/smee/internal/firmware/u-boot.bin"; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "U-Boot binary is unchanged"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "U-Boot binary has changed"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "No existing U-Boot binary found, will create new one"
          fi

          # Copy the new binary
          cp u-boot.bin "${{ github.workspace }}/main/smee/internal/firmware/"

          # Get file size for reporting
          size=$(stat -c%s "${{ github.workspace }}/main/smee/internal/firmware/u-boot.bin")
          echo "size=$size" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: main
          commit-message: |
            Update U-Boot binary to ${{ env.UBOOT_VERSION }}

            - Built U-Boot ${{ env.UBOOT_VERSION }} for Raspberry Pi 4 ARM64
            - Binary size: ${{ steps.check_changes.outputs.size }} bytes
            - Configured for PXE boot: "dhcp; pxe get; pxe boot"
            - Built natively on ubuntu-24.04-arm runner
          title: "chore: Update U-Boot binary to ${{ env.UBOOT_VERSION }}"
          body: |
            ## U-Boot Build Update

            This PR updates the U-Boot binary to version `${{ env.UBOOT_VERSION }}`.

            ### Changes
            - ‚úÖ Built U-Boot ${{ env.UBOOT_VERSION }} for Raspberry Pi 4 ARM64
            - ‚úÖ Binary size: ${{ steps.check_changes.outputs.size }} bytes
            - ‚úÖ Configured with custom bootcommand: `dhcp; pxe get; pxe boot`
            - ‚úÖ Built natively on `ubuntu-24.04-arm` runner (no cross-compilation)

            ### Build Configuration
            - **Target**: `rpi_arm64_defconfig` (Raspberry Pi 4 ARM64)
            - **Compiler**: `aarch64-linux-gnu-gcc`
            - **Boot Method**: PXE/DHCP boot for diskless operation

            ### Verification
            The build process replicated the same steps as the Docker-based build in `cmd/uboot/` but executed natively on ARM64 hardware for optimal compatibility.

            ---

            *This PR was automatically created by the U-Boot build workflow.*
          branch: update-uboot-${{ env.UBOOT_VERSION }}-${{ github.run_number }}
          delete-branch: true
          draft: false
          labels: |
            firmware
            uboot
            automated-pr

      - name: Report build status
        run: |
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "‚úÖ U-Boot build completed successfully"
            echo "üìù Pull request created with updated binary"
            echo "üìè Binary size: ${{ steps.check_changes.outputs.size }} bytes"
          else
            echo "‚ÑπÔ∏è U-Boot binary is up-to-date, no changes needed"
          fi
