# Raspberry Pi TFTP Handler

This package provides support for Raspberry Pi native netboot via TFTP.

## Overview

The Raspberry Pi handler serves files requested by Raspberry Pi devices during their native network boot process. It supports both:

1. **Templated configuration files** - Dynamic generation of `config.txt` and `cmdline.txt`
2. **Raw boot files** - Serving kernel images, firmware, device tree blobs, etc. from the cache directory

## Architecture

### Path Pattern

Raspberry Pi devices request files using the following TFTP path pattern:

```
<serial-or-mac>/<filename>
```

Examples:
- `b827eb123456/config.txt` (serial number format)
- `b8-27-eb-12-34-56/cmdline.txt` (MAC address with dashes)
- `dca632abcdef/overlays/vc4-kms-v3d.dtbo` (nested paths)

### MAC Address Detection

The handler extracts the MAC address from the request path and verifies it against known Raspberry Pi OUI prefixes:
- `B8:27:EB` - Original Raspberry Pi
- `DC:A6:32` - Raspberry Pi 3B+, 4, etc.
- `E4:5F:01` - Raspberry Pi 4
- `28:CD:C1` - Raspberry Pi 5
- `D8:3A:DD` - Raspberry Pi Compute Module
- `2C:CF:67` - Raspberry Pi Zero 2

This uses the existing `dhcp.IsRaspberryPI()` function for validation.

## File Handling

### Templated Files

The following files are dynamically generated from templates:

#### config.txt
```
# Raspberry Pi Config - <MAC>
# Auto-generated by Tinkerbell

dtparam=audio=on
gpu_mem=64

kernel=kernel8.img
enable_uart=1
```

#### cmdline.txt
```
console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait tinkerbell=1
```

Templates can be extended by modifying the `ConfigTemplates` map or by adding backend integration to fetch hardware-specific configuration.

### Raw Files

All other files (kernel images, firmware, device tree overlays, etc.) are served directly from the configured cache directory. This includes:
- `bootcode.bin` - First-stage bootloader
- `start*.elf` - GPU firmware
- `fixup*.dat` - GPU memory split configuration
- `kernel*.img` - Linux kernel
- `*.dtb` - Device tree blobs
- `overlays/*.dtbo` - Device tree overlays

## Integration

The handler is automatically registered in the TFTP server with a regex pattern that matches Raspberry Pi boot paths. It's inserted before the default hook handler to ensure proper routing:

```go
// In smee/internal/tftp/servers.go
mux.Handle(`^([0-9a-fA-F]{8,12}|[0-9a-fA-F]{2}-[0-9a-fA-F]{2}-[0-9a-fA-F]{2}-[0-9a-fA-F]{2}-[0-9a-fA-F]{2}-[0-9a-fA-F]{2})/.*$`, rpi.Handler{
    Logger:   c.Logger,
    CacheDir: c.CacheDir,
})
```

## Future Enhancements

Potential improvements include:

1. **Backend Integration** - Fetch hardware-specific kernel arguments and boot configuration from the Hardware CRD
2. **Conditional DTB Selection** - Automatically select appropriate device tree based on Pi model
3. **Network Configuration** - Inject VLAN, static IP, or other network settings into cmdline.txt
4. **Custom Templates** - Allow users to provide custom config.txt/cmdline.txt templates
5. **Metrics** - Add Prometheus metrics for RPI boot requests

## Testing

Run tests with:
```bash
go test ./smee/internal/tftp/rpi/...
```

Tests cover:
- MAC address extraction from serial numbers and MAC formats
- Path pattern matching
- Template rendering
- Raw file serving
- Security (path traversal protection)
- Integration scenarios

## Security

The handler includes path traversal protection to ensure files are only served from within the configured cache directory. All file paths are cleaned and validated before access.

## OpenTelemetry

The handler is instrumented with OpenTelemetry spans for observability:
- Span name: `TFTP Raspberry Pi file serve`
- Attributes:
  - `rpi.identifier` - Serial number or MAC from path
  - `rpi.filename` - Requested filename
  - `rpi.mac` - Parsed MAC address (if available)
  - `rpi.verified` - Boolean indicating if MAC matched Raspberry Pi OUI
